@{
    ViewBag.Title = "Chat";
    Layout = "~/Views/Shared/_ChatLayout.cshtml";
}

<h2>Chat</h2>


<div class="Admin" id="divMessageAdmin" style="background-color:red;">
    <div class="welcome"></div><br />
    <div id="divWaitingUser"></div><br />
    <input id="txtMessage" type="text" />
    <input id="btnSendMessage" type="button" value="Send" />
    <div id="divAdminMessage"></div>
</div>

<div class="User" id="divMessageUser" style="background-color:blue;">
    <div class="welcome"></div><br />
    <input id="txtUserMessage" type="text" />
    <input id="btnSendUserMessage" type="button" value="Send" />
    <div id="divUserMessage"></div>
</div>

<div id="unauthUsrName" class="mylogin" style="background-color:green;">
    Provide a Username:<input id="txtUserName" type="text" /><br />
    <input id="unAuthConnect" type="button" value="Connect to chat" />
    <div id="divalarm"></div>
</div>

    <input id="hId" type="hidden" />
    <input id="hUserName" type="hidden" />
    <input id="hGroup" type="hidden" />

@section scripts {
    <script src="~/Scripts/jquery-1.10.2.min.js"></script>
    <script src="~/Scripts/jquery.signalR-2.2.1.min.js"></script>
    <script src="~/signalr/hubs" type="text/javascript"></script>

    <script>
        $(function () {
           var objHub = $.connection.chatHub;
           loadClientMethods(objHub);
           $.connection.hub.start().done(function () {
               loadEvents(objHub);
           });
       });

        function loadEvents(objHub) {

            $("#unAuthConnect").click(function () {
                var name = $("#txtUserName").val();
                if (name.length > 0) {
                    // <<<<<-- ***** Return to Server [  Connect  ] *****
                    objHub.server.unAuthConnect(name);
                }
                else {
                    alert("Please Insert UserName");
                }

            });

          var name = '@HttpContext.Current.User.Identity.Name';
          objHub.server.connect(name);

           $('#btnSendMessage').click(function () {

               var msg = $("#txtMessage").val();
               if (msg.length > 0) {
                   var username = $('#hUserName').val();
                   document.getElementById('txtMessage').value = "";
                   // <<<<<-- ***** Return to Server [  SendMessageToGroup  ] *****
                   objHub.server.sendMessageToGroup(username, msg);
               }
           });

           $('#btnSendUserMessage').click(function () {
              // alert("wrks");
               var msg = $("#txtUserMessage").val();
               if (msg.length > 0) {
                   var username = $('#hUserName').val();
                   document.getElementById('txtUserMessage').value = "";
                   // <<<<<-- ***** Return to Server [  SendMessageToGroup  ] *****
                   objHub.server.sendMessageToGroup(username, msg);
               }
           });

           $("#txtMessage").keypress(function (e) {
               if (e.which == 13) {
                   $('#btnSendMessage').click();
               }
           });
       }

        function loadClientMethods(objHub) {
            $("#divMessageAdmin").hide();
            $("#divMessageUser").hide();
            $("#unauthUsrName").hide();
           @{
                if (!User.Identity.IsAuthenticated)
                {
                    <text>
                    $("#unauthUsrName").show();
                    </text>
                }
            }
           objHub.client.getMessagesAdmin = function (userName, message) {
                   $(".txtMessage").val('');
                   $('#divAdminMessage').append('<div><p>' + userName + ': ' + message + '</p></div>');
                   var height = $('#divAdminMessage')[0].scrollHeight;
                   $('#divAdminMessage').scrollTop(height);
           }

           objHub.client.getMessagesUser = function (userName, message) {
               $("#txtMessage").val('');
               $('#divUserMessage').append('<div><p>' + userName + ': ' + message + '</p></div>');
               var height = $('#divUserMessage')[0].scrollHeight;
               $('#divUserMessage').scrollTop(height);
           }

           objHub.client.onConnected = function (id, userName, userGroup, flag) {
               //alert(flag);
               $("#unauthUsrName").hide();
               var strWelcome = 'Welcome' + +userName;
               $('.welcome').append('<div><p>Welcome:' + userName + '</p></div>');
               $('#hId').val(id);
              // $('#hUserId').val(UserID);
               $('#hUserName').val(userName);
               $('#hGroup').val(userGroup);
               if ( flag == "1") {

                   $("#divMessageAdmin").show();
               }
               else {
                   $("#divMessageUser").show();

               }
           }
       }
    </script>
}
